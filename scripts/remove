#!/bin/bash

#=================================================
# GENERIC STARTING
#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# LOAD SETTINGS
#=================================================

app=$YNH_APP_INSTANCE_NAME

port=$(ynh_app_setting_get $app port)

#=================================================
# STANDARD REMOVE
#=================================================
# DISABLE SERVICE IN ADMIN PANEL
#=================================================

# Retire le service du monitoring de Yunohost.
if yunohost service status | grep -q minidlna	# Test l'existence du service dans Yunohost
then
	ynh_print_info "Remove minidlna service" >&2
	yunohost service remove minidlna
fi

#=================================================
# CLOSE THE PORTS
#=================================================

# Ferme les ports dans le firewall
ynh_exec_fully_quiet yunohost firewall disallow TCP $port
ynh_exec_fully_quiet yunohost firewall disallow UDP 1900

#=================================================
# SPECIFIC REMOVE
#=================================================
# REMOVE MINIDNLA
#=================================================

apt-get -y purge minidlna
ynh_secure_remove "/etc/apt/sources.list.d/minidlna.list"

#=================================================
# REMOVE INOTIFY'S CONFIG
#=================================================

# Suppression du paramÃ¨tre inotify pour minidlna.
if [ -e "/etc/sysctl.d/90-inotify_minidlna.conf" ]; then
	ynh_print_info "Delete kernel config" >&2
	ynh_secure_remove "/etc/sysctl.d/90-inotify_minidlna.conf"
	# Et rechargement de la config du noyau.
	if ! IS_PACKAGE_CHECK; then
		sysctl -p /etc/sysctl.d/90-inotify_minidlna.conf
	fi
fi
