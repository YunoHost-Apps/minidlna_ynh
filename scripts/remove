#!/bin/bash

#=================================================
# GENERIC STARTING
#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# LOAD SETTINGS
#=================================================

app=$YNH_APP_INSTANCE_NAME

port=$(ynh_app_setting_get $app port)

#=================================================
# STANDARD REMOVE
#=================================================
# DISABLE SERVICE IN ADMIN PANEL
#=================================================

# Retire le service du monitoring de Yunohost.
if sudo yunohost service status | grep -q minidlna	# Test l'existence du service dans Yunohost
then
	echo "Remove minidlna service"
	sudo yunohost service remove minidlna
fi

#=================================================
# CLOSE THE PORTS
#=================================================

# Ferme les ports dans le firewall
ALL_QUIET sudo yunohost firewall disallow TCP $port
ALL_QUIET sudo yunohost firewall disallow UDP 1900

#=================================================
# SPECIFIC REMOVE
#=================================================
# REMOVE MINIDNLA
#=================================================

sudo apt-get -y purge minidlna
ynh_secure_remove "/etc/apt/sources.list.d/minidlna.list"

#=================================================
# REMOVE INOTIFY'S CONFIG
#=================================================

# Suppression du param√®tre inotify pour minidlna.
if [ -e "/etc/sysctl.d/90-inotify_minidlna.conf" ]; then
	echo "Delete kernel config"
	ynh_secure_remove "/etc/sysctl.d/90-inotify_minidlna.conf"
	# Et rechargement de la config du noyau.
	if IS_PACKAGE_CHECK; then
		sudo sysctl -p /etc/sysctl.d/90-inotify_minidlna.conf
	fi
fi
