#!/bin/bash

#=================================================
# GENERIC STARTING
#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# LOAD SETTINGS
#=================================================

app=$YNH_APP_INSTANCE_NAME

port=$(ynh_app_setting_get $app port)

#=================================================
# STANDARD REMOVE
#=================================================
# DISABLE SERVICE IN ADMIN PANEL
#=================================================

# Retire le service du monitoring de Yunohost.
if sudo yunohost service status | grep -q minidlna	# Test l'existence du service dans Yunohost
then
	echo "Remove minidlna service"
	sudo yunohost service remove minidlna
fi

#=================================================
# CLOSE THE PORTS
#=================================================

# Ferme les ports dans le firewall
if sudo yunohost firewall list | grep -q "\- $port$"
then
	echo "Close port $port"
	QUIET sudo yunohost firewall disallow TCP $port
fi
if sudo yunohost firewall list | grep -q "\- 1900$"
then
	echo "Close port 1900"
	QUIET sudo yunohost firewall disallow UDP 1900
fi

#=================================================
# SPECIFIC REMOVE
#=================================================
# REMOVE MINIDNLA
#=================================================

# Suppression du paquet minidlna
if [ -e "/usr/sbin/minidlnad" ] || [ -e "/usr/bin/minidlnad" ]; then
	echo "Remove minidlna package"
	sudo apt-get -y purge minidlna
fi
if [ -e "/etc/apt/sources.list.d/minidlna.list" ]; then
	echo "Delete sources.list config"
	sudo rm "/etc/apt/sources.list.d/minidlna.list"
fi

#=================================================
# REMOVE INOTIFY'S CONFIG
#=================================================

# Suppression du param√®tre inotify pour minidlna.
if [ -e "/etc/sysctl.d/90-inotify_minidlna.conf" ]; then
	echo "Delete kernel config"
	sudo rm "/etc/sysctl.d/90-inotify_minidlna.conf"
	# Et rechargement de la config du noyau.
	sudo sysctl --system
fi
