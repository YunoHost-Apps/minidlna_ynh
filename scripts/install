#!/bin/bash

ynh_version=$(sudo yunohost -v | grep "moulinette:" | cut -d' ' -f2 | cut -d'.' -f1,2)
# Retrieve arguments
if [ $ynh_version = "2.4" ]
then
	version=$YNH_APP_ARG_VERSION

	app=$YNH_APP_INSTANCE_NAME

	# Source app helpers
	source /usr/share/yunohost/helpers
else
	version=$1
	app=minidlna
fi


# Delete files and db if exit with an error
EXIT_PROPERLY () {
	trap '' ERR
	echo -e "\e[91m \e[1m"	# Shell in light red bold
	echo -e "!!\n  $app install's script has encountered an error. Installation was cancelled.\n!!"

	if [ $ynh_version = "2.2" ]; then
		/bin/bash ./remove	# Appel le script remove. En 2.2, ce comportement n'est pas automatique.
	fi
	exit 1
}
TRAP_ON () {	# Activate signal capture
	trap EXIT_PROPERLY ERR	# Capturing exit signals on error
}
TRAP_OFF () {	# Ignoring signal capture until TRAP_ON
# Pour une raison que j'ignore, la fonction TRAP_ON fonctionne très bien.
# Mais pas la fonction TRAP_OFF...
# Utiliser directement `trap '' ERR` dans le code pour l'utiliser, à la place de la fonction.
	trap '' ERR	# Ignoring exit signals
}
TRAP_ON


# Cherche un port libre.
port=48200
sudo yunohost app checkport $port
while [[ ! $? -eq 0 ]]; do
    port=$((port+1))
    sudo yunohost app checkport $port
done

# Ouvre les ports dans le firewall
sudo yunohost firewall allow --no-upnp TCP $port > /dev/null 2>&1
sudo yunohost firewall allow --no-upnp UDP 1900 > /dev/null 2>&1	# Découverte SSDP pour UPNP.

# Enregistre les infos dans la config YunoHost
sudo yunohost app setting $app version -v ${version:0:1}
sudo yunohost app setting $app port -v $port

# Création du dossier yunohost.multimedia
wget https://github.com/maniackcrudelis/yunohost.multimedia/archive/master.zip
unzip master.zip
sudo ./yunohost.multimedia-master/script/ynh_media_build.sh

# Installation du paquet minidlna et ses dépendances
if [ ${version:0:1} = "B" ]
then	# Installation de la version minidlna disponible dans backport. (En cas de problème avec la version actuelle des dépots)
	codename=$(lsb_release -a 2>/dev/null | grep Codename | cut -f 2)
	sudo sed -i "s@__CODENAME__@$codename@g" ../conf/minidlna.list
	sudo cp -a ../conf/minidlna.list /etc/apt/sources.list.d/
	sudo apt-get update
	sudo apt-get -t $codename-backports -y install minidlna
else	# Installation de la version minidlna des dépots courants.
	sudo apt-get update
	sudo apt-get -y install minidlna
fi

# Augmentation du nombre maximum de fichiers surveillés par inotify.
sudo cp -a ../conf/90-inotify_minidlna.conf /etc/sysctl.d/
# Et rechargement de la config du noyau.
sudo sysctl --system

# Ajoute le service au monitoring de Yunohost.
sudo yunohost service add minidlna --log "/var/log/minidlna.log"

# Modifie la configuration de minidlna
sudo sed -i 's@^#*media_dir=.*@media_dir=/home/yunohost.multimedia/share@' /etc/minidlna.conf
sudo sed -i "s/^#*port=.*/port=$port/" /etc/minidlna.conf
sudo sed -i "s/^#*friendly_name=.*/friendly_name=Yunohost DLNA/" /etc/minidlna.conf
sudo sed -i "s/^#*root_container=.*/root_container=B/" /etc/minidlna.conf

# Redémarre minidlna pour prendre en compte la nouvelle configuration
sudo service minidlna restart

# Régénère la configuration de SSOwat
sudo yunohost app ssowatconf
